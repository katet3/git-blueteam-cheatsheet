Регистр
При проведении криминалистического анализа вы часто будете слышать слово "артефакт". Криминалистические артефакты - это важные фрагменты информации, которые служат доказательством человеческой деятельности. Например, при исследовании места преступления отпечатки пальцев, сломанная пуговица рубашки или пальто, инструменты, использованные для совершения преступления, - все это считается криминалистическими артефактами. Все эти артефакты объединяются для воссоздания истории о том, как было совершено преступление. 

В компьютерной криминалистике криминалистические артефакты могут представлять собой небольшие следы деятельности, оставленные на компьютерной системе. В системе Windows действия человека можно достаточно точно отследить с помощью компьютерной криминалистики благодаря различным артефактам, которые система Windows создает для определенного вида деятельности. Эти артефакты часто находятся в местах, куда "обычные" пользователи обычно не заглядывают. Для наших целей эти артефакты могут быть проанализированы, чтобы предоставить доказательства активности для расследования.

---
Реестр Windows представляет собой набор баз данных, содержащих данные о конфигурации системы. Эти данные могут касаться аппаратного обеспечения, программного обеспечения или информации о пользователе. Он также включает данные о недавно использованных файлах, программах или устройствах, подключенных к системе. Как вы понимаете, эти данные полезны с точки зрения криминалистики. В этом номере мы изучим способы чтения этих данных для выявления необходимой информации о системе. Вы можете просмотреть реестр с помощью regedit.exe, встроенной утилиты Windows для просмотра и редактирования реестра. Другие инструменты для изучения реестра мы рассмотрим в следующих заданиях.

Реестр Windows состоит из Ключей и Значений. Когда вы открываете утилиту regedit.exe для просмотра реестра, папки, которые вы видите, являются ключами реестра. Значения реестра - это данные, хранящиеся в этих ключах реестра. Улей реестра - это группа ключей, подключей и значений, хранящихся в одном файле на диске.

Реестр любой системы Windows содержит следующие пять корневых ключей:
    HKEY_CURRENT_USER
    HKEY_HKEY_USERS
    HKEY_LOCAL_MACHINE
    HKEY_CLASSES_ROOT
    HKEY_CURRENT_CONFIG
    
HKEY_CURRENT_USER Содержит корень информации о конфигурации пользователя, который в данный момент вошел в систему. Здесь хранятся папки пользователя, цвета экрана и настройки панели управления. Эта информация связана с профилем пользователя. Этот ключ иногда сокращенно называют HKCU.
HKEY_USERS Содержит все активно загруженные профили пользователей на компьютере. HKEY_CURRENT_USER является подключом HKEY_USERS. HKEY_USERS иногда сокращенно называют HKU.
HKEY_LOCAL_MACHINE Содержит информацию о конфигурации, характерную для данного компьютера (для любого пользователя). Этот ключ иногда сокращенно называют HKLM.
HKEY_CLASSES_ROOT  

так же
Большинство этих разделов находятся в каталоге C:\Windows\System32\Config и являются:
    DEFAULT (монтируется в HKEY_USERS\DEFAULT)
    SAM (устанавливается в HKEY_LOCAL_MACHINE\SAM)
    SECURITY (устанавливается на HKEY_LOCAL_MACHINE\Security)
    SOFTWARE (устанавливается на HKEY_LOCAL_MACHINE\Software)
    SYSTEM (устанавливается на HKEY_LOCAL_MACHINE\System)

Ульи, содержащие информацию о пользователях:
Кроме этих ульев, в каталоге User profile можно найти еще два улья, содержащие информацию о пользователе. Для Windows 7 и выше, каталог профиля пользователя находится в C:\Users\<имя пользователя>\, где находятся следующие ульи:

NTUSER.DAT (устанавливается на HKEY_CURRENT_USER, когда пользователь входит в систему)
    USRCLASS.DAT (монтируется в HKEY_CURRENT_USER\Software\CLASSES).

Улей USRCLASS.DAT находится в каталоге C:\Users\<имя пользователя>\AppData\Local\Microsoft\Windows. 


Улей NTUSER.DAT находится в каталоге C:\Users\<username>\.

NTUSER.DAT и USRCLASS.DAT являются скрытыми файлами.

После извлечения ульев реестра нам понадобится инструмент для просмотра этих файлов в редакторе реестра. Поскольку редактор реестра работает только с живыми системами и не может загружать экспортированные ветки реестра, мы можем использовать следующие инструменты:

Registry Viewer:
Как видно на скриншоте ниже, программа просмотра реестра AccessData имеет схожий пользовательский интерфейс с редактором реестра Windows. Однако есть несколько ограничений. Он загружает только один улей за раз и не может учитывать журналы транзакций.

Zimmerman's Registry Explorer:
Эрик Циммерман разработал несколько инструментов, которые очень полезны для проведения цифровой криминалистики и реагирования на инциденты. Одним из них является Registry Explorer. Он выглядит так, как показано на скриншоте ниже. Он может загружать несколько ульев одновременно и добавлять данные из журналов транзакций в улей, чтобы сделать более "чистый" улей с более актуальными данными. В нем также есть удобная опция "Закладки", содержащая криминалистически важные ключи реестра, которые часто ищут криминалисты. С помощью пункта меню "Закладки" следователи могут сразу перейти к интересным ключам и значениям реестра. Мы рассмотрим их более подробно в следующих заданиях.

---
Версия ОС:
Если для проведения экспертизы у нас есть только сортировочные данные, мы можем определить версию ОС, из которой эти данные были извлечены через реестр. Чтобы найти версию ОС, мы можем использовать следующий ключ реестра:
SOFTWARE\Microsoft\Windows NT\CurrentVersion

Очень важно установить эту информацию до начала анализа. Как мы увидим, многие криминалистические артефакты, которые мы собираем, будут собраны из наборов управления.
Имя компьютера:
При проведении криминалистического анализа крайне важно установить имя компьютера, чтобы убедиться, что мы работаем на той машине, на которой должны работать. Мы можем найти имя компьютера в следующем месте:
SYSTEM\CurrentControlSet\Control\ComputerName\ComputerName 

Информация о часовом поясе:
Для точности важно установить, в каком часовом поясе находится компьютер. Это поможет нам понять хронологию событий, как они происходили. Чтобы найти информацию о часовом поясе, мы можем посмотреть на следующее место:
SYSTEM\CurrentControlSet\Control\TimeZoneInformation

Сетевые интерфейсы и прошлые сети:
Следующий ключ реестра даст список сетевых интерфейсов на исследуемой машине:
SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces

Каждый интерфейс представлен уникальным идентификатором (GUID), который содержит значения, относящиеся к конфигурации TCP/IP интерфейса. Этот ключ предоставляет нам такую информацию, как IP-адреса, IP-адрес и маска подсети DHCP, DNS-серверы и многое другое. Эта информация очень важна, поскольку она помогает убедиться, что мы проводите экспертизу именно на той машине, на которой она должна проводиться.
Сети, к которым в прошлом была подключена данная машина, можно найти в следующих местах:
SOFTWARE\Microsoft\Windows NT\CurrentVersion\NetworkList\Signatures\Unmanaged
SOFTWARE\Microsoft\Windows NT\CurrentVersion\NetworkList\Signatures\Managed
Эти ключи реестра содержат прошлые сети, а также последний раз, когда они были подключены. Время последней записи ключа реестра указывает на последний раз, когда эти сети были подключены.

Программы автозапуска (Autoruns):

Следующие ключи реестра содержат информацию о программах или командах, которые запускаются при входе пользователя в систему. 

NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Run
NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\RunOnce
SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
SOFTWARE\Microsoft\Windows\CurrentVersion\policies\Explorer\Run
SOFTWARE\Microsoft\Windows\CurrentVersion\Run

Следующий ключ реестра содержит информацию о службах:
SYSTEM\CurrentControlSet\Services

Улей SAM и информация о пользователях:
В улье SAM содержится информация об учетной записи пользователя, информация о входе в систему и информация о группах. Эта информация в основном находится в следующем месте:
SAM\Domains\Account\Users

---
Недавние файлы:
Windows ведет список недавно открытых файлов для каждого пользователя. Как мы могли видеть при использовании проводника Windows, он показывает нам список недавно использованных файлов. Эта информация хранится в ветке NTUSER и может быть найдена в следующем месте:
NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs

---
Идентификация устройств:
Следующие места хранят информацию о USB-носителях, подключенных к системе. В этих местах хранятся идентификатор производителя, идентификатор продукта и версия подключенного USB-устройства, которые можно использовать для идентификации уникальных устройств. В этих местах также хранится время, когда устройства были подключены к системе.
SYSTEM\CurrentControlSet\Enum\USBSTOR
SYSTEM\CurrentControlSet\Enum\USB

-------------------------------------------------------------------------------------------


Память
----------------------------------------------
Понимание того, как функционирует операционная система Windows, крайне важно для защитника. Сейчас расскажу о видах процессах и 
которые нам будут интересны в данный момент


Процуссы по привилегиям делятся на два типа

User Mode:
Когда вы запускаете приложение в пользовательском режиме, Windows создает процесс для приложения. 
Процесс предоставляет приложению частное виртуальное адресное пространство и частную таблицу дескрипторов. 
Поскольку виртуальное адресное пространство приложения является частным

Kernel Mode:
Весь код, работающий в режиме ядра, разделяет единое виртуальное адресное пространство. 
Поэтому драйвер режима ядра не изолирован от других драйверов и самой операционной системы. 
Если драйвер режима ядра случайно записывает данные в неправильный виртуальный адрес, данные, 
принадлежащие операционной системе или другому драйверу, могут быть скомпрометированы. 
При сбое драйвера режима ядра происходит сбой всей операционной системы.

---
Первым запускаемым приложением является system в kernel mode

Процесс System (идентификатор процесса 4) является домом для особого вида потоков, которые выполняются только 
в режиме ядра - системных потоков в режиме ядра. Системные потоки имеют все атрибуты и контексты обычных потоков пользовательского режима (такие как аппаратный контекст, приоритет и так далее), но отличаются тем, что выполняются только в режиме ядра, исполняя код, загруженный в системное пространство, будь то Ntoskrnl.exe или любой другой загруженный драйвер устройства. Кроме того, системные потоки не имеют адресного пространства пользовательского процесса и, следовательно, должны выделять 
любую динамическую память из кучи памяти операционной системы

---
Процесс в user mode
explorer.exe. 
Этот процесс предоставляет пользователю доступ к его папкам и файлам. 
Он также обеспечивает функциональность других функций, таких как меню "Пуск" и панель задач.

Будет много дочерних процессов для explorer.exe.
Дочерние процессы Explorer.exe.
Что является нормальным?
Свойства Explorer.exe.
Путь к образу: %SystemRoot%\explorer.exe
Родительский процесс:  Создается userinit.exe и завершается
Количество экземпляров:  Один или более для каждого интерактивно вошедшего пользователя.
Учетная запись пользователя:  Вошедший в систему пользователь (пользователи)
Время запуска:  Первый экземпляр, когда начинается первый интерактивный сеанс входа пользователя в систему.

Что является необычным?
    Фактический родительский процесс. (userinit.exe вызывает этот процесс и выходит из него)
    Путь к файлу образа, отличный от C:\Windows
    Запуск от имени неизвестного пользователя
    Тонкие ошибки в написании, чтобы скрыть неавторизованные процессы на виду у всех
    Исходящие TCP/IP соединения
Вид свойств Explorer.exe.


